<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>99 Nights - Fix Test</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; text-shadow: 1px 1px 2px black; pointer-events: none; }
    </style>
</head>
<body>

<div id="ui">
    <h1>99 Nights: Лес</h1>
    <p>Нажми <b>CTRL</b> для управления камерой</p>
    <p>Ходьба: <b>W, A, S, D</b></p>
</div>

<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import { OBJLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/OBJLoader.js';
    import { MTLLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/MTLLoader.js';

    // --- 1. СЦЕНА И РЕНДЕР ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB); // Голубое небо
    
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // --- 2. СВЕТ ---
    const ambient = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambient);

    const sun = new THREE.DirectionalLight(0xffffff, 1.2);
    sun.position.set(10, 20, 10);
    sun.castShadow = true;
    scene.add(sun);

    // --- 3. ПОЛ И СЕТКА (Чтобы видеть пространство) ---
    const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(200, 200),
        new THREE.MeshStandardMaterial({ color: 0x355e3b })
    );
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    const grid = new THREE.GridHelper(200, 40, 0xffffff, 0x444444);
    scene.add(grid);

    // --- 4. ЗАГРУЗКА ОБЪЕКТОВ ---
    const objLoader = new OBJLoader();
    const mtlLoader = new MTLLoader();

    function safeLoad(path, name, pos, scale = 1) {
        mtlLoader.setPath(path);
        mtlLoader.load(name + '.mtl', (mtl) => {
            mtl.preload();
            objLoader.setMaterials(mtl);
            objLoader.setPath(path);
            objLoader.load(name + '.obj', (obj) => {
                obj.position.copy(pos);
                obj.scale.setScalar(scale);
                obj.traverse(n => { if(n.isMesh) n.castShadow = true; });
                scene.add(obj);
                console.log("Успешно загружен:", name);
            }, undefined, (e) => console.error("Ошибка OBJ:", name));
        }, undefined, (e) => console.error("Ошибка MTL:", name));
    }

    // Загружаем твои модели
    safeLoad('models/models_game/', 'bonfire', new THREE.Vector3(0, 0, 0), 1);
    safeLoad('models/models_game/', 'tree', new THREE.Vector3(5, 0, -5), 2);
    safeLoad('models/models_game/', 'big_tree', new THREE.Vector3(-8, 0, -10), 3);
    safeLoad('models/models_animals/', 'wolf', new THREE.Vector3(-5, 0, 5), 1.2);

    // --- 5. ИГРОК (Яркий красный куб) ---
    const player = new THREE.Group();
    const body = new THREE.Mesh(
        new THREE.BoxGeometry(1, 2, 1), 
        new THREE.MeshStandardMaterial({ color: 0xff0000 })
    );
    body.position.y = 1; 
    player.add(body);
    player.position.set(0, 0, 15); // Начинаем чуть поодаль от центра
    scene.add(player);

    // --- 6. УПРАВЛЕНИЕ ---
    let isLocked = false, yaw = 0, pitch = 0;
    const keys = {};

    document.addEventListener('keydown', (e) => {
        keys[e.code] = true;
        if(e.code === 'ControlLeft') {
            isLocked = !isLocked;
            if(isLocked) document.body.requestPointerLock(); else document.exitPointerLock();
        }
    });
    document.addEventListener('keyup', (e) => keys[e.code] = false);
    document.addEventListener('mousemove', (e) => {
        if(isLocked) {
            yaw -= e.movementX * 0.003;
            pitch = Math.max(-1, Math.min(1, pitch - e.movementY * 0.003));
        }
    });

    // --- 7. ЦИКЛ ОБНОВЛЕНИЯ ---
    function animate() {
        requestAnimationFrame(animate);

        // Движение
        const dir = new THREE.Vector3();
        if(keys['KeyW']) dir.z -= 1;
        if(keys['KeyS']) dir.z += 1;
        if(keys['KeyA']) dir.x -= 1;
        if(keys['KeyD']) dir.x += 1;

        if(dir.length() > 0) {
            dir.normalize().applyAxisAngle(new THREE.Vector3(0, 1, 0), yaw);
            player.position.add(dir.multiplyScalar(0.15));
            player.rotation.y = yaw + Math.PI;
        }

        // Камера (Третье лицо)
        const camDist = 10;
        camera.position.set(
            player.position.x + Math.sin(yaw) * camDist,
            player.position.y + 5 + pitch * 5,
            player.position.z + Math.cos(yaw) * camDist
        );
        camera.lookAt(player.position.x, player.position.y + 1, player.position.z);

        renderer.render(scene, camera);
    }

    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
